<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Nutrition Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#1D4ED8',
                        'secondary': '#DC2626',
                        'success': '#10B981',
                        'warning': '#F59E0B',
                        'info': '#3B82F6',
                        'protein': '#EF4444',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .progress-bar-container { height: 8px; background-color: #374151; border-radius: 9999px; overflow: hidden; }
        .progress-bar { height: 100%; transition: width 0.3s ease; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #4B5563; border-radius: 10px; }
        .custom-scrollbar { scrollbar-width: thin; scrollbar-color: #4B5563 #1F2937; }
        .input-as-text { border: none; background: none; padding: 0; color: inherit; font-size: inherit; font-weight: inherit; outline: none; text-align: center; width: 100%; }
        .input-as-text:focus { border-bottom: 1px solid #1D4ED8; background-color: #1F2937; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.75); z-index: 50; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body class="bg-gray-900 min-h-screen p-4 sm:p-8 text-white">

    <div id="shopping-list-modal" class="modal-backdrop hidden">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-gray-700">
            <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-6">
                <h2 class="text-3xl font-bold text-success">ðŸ›’ Weekly Shopping List</h2>
                <button id="close-shopping-list" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark fa-2x"></i></button>
            </div>
            <div id="shopping-list-content"></div>
        </div>
    </div>
    
    <div id="email-confirmation-modal" class="modal-backdrop hidden">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto border border-gray-700">
            <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-6">
                <h2 class="text-3xl font-bold text-primary">ðŸ“§ Final Plan Review</h2>
                <button id="close-email-modal" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark fa-2x"></i></button>
            </div>
            <div id="email-payload-content">
                <p class="text-gray-300 mb-2">Ready to deliver. This action will launch your email client with the plan summary.</p>
                <div class="p-3 bg-gray-900 rounded-lg text-sm mb-4">
                    <p class="text-gray-400">Recipient: <strong class="text-white" id="recipient-email"></strong></p>
                </div>
                <h3 class="text-xl font-bold text-gray-200 mb-2">Email Preview:</h3>
                <div class="bg-gray-900 p-4 rounded-lg text-sm font-mono text-gray-200 whitespace-pre-wrap max-h-60 overflow-y-auto">
                    <pre id="payload-display"></pre>
                </div>
                <a id="mail-to-link" href="#" class="block w-full text-center py-3 mt-6 bg-success text-white font-bold rounded-lg shadow-lg hover:bg-green-600 transition duration-150">
                    <i class="fa-solid fa-envelope mr-2"></i> Open Email Client
                </a>
            </div>
        </div>
    </div>

<script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyA_D8lToqMx6-9wVei86AVrhtFsoPNRzUA",
            authDomain: "nutritionplangenerator.firebaseapp.com",
            projectId: "nutritionplangenerator",
            storageBucket: "nutritionplangenerator.firebasestorage.app",
            messagingSenderId: "1063853006421",
            appId: "1:1063853006421:web:cb006ba01f538a9ea57edc" 
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- 2. GLOBAL STATE ---
        let currentPlan = null;
        let clientId = null;
        let currentDayIndex = 0;
        let isGoalEditing = false;
        let mealEditingState = {};
        let mealAddBarVisible = {};
        let activeSearches = {};
        const MAX_SEARCH_RESULTS = 8;

        const CAL_PER_PRO = 4;
        const CAL_PER_CARB = 4;
        const CAL_PER_FAT = 9;

        let FOOD_DB = {}; 

        // --- 3. INITIALIZATION & AUTH ---
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            clientId = urlParams.get('id');

            if (!clientId) {
                alert("No Client ID found. Redirecting to dashboard.");
                window.location.href = "dashboard.html";
                return;
            }

            auth.onAuthStateChanged((user) => {
                if (user) {
                    console.log("Authorized. Loading data for client:", clientId);
                    loadDataFromFirebase();
                } else {
                    window.location.href = "login.html";
                }
            });

            document.getElementById('close-shopping-list').onclick = () => document.getElementById('shopping-list-modal').classList.add('hidden');
            document.getElementById('close-email-modal').onclick = () => document.getElementById('email-confirmation-modal').classList.add('hidden');
        };

        // --- 4. DATA LOADING (UPDATED FOR N8N) ---
        async function loadDataFromFirebase() {
            try {
                // A. Fetch Client Profile
                const clientDoc = await db.collection("clients").doc(clientId).get();
                if (!clientDoc.exists) throw new Error("Client not found");
                const clientData = clientDoc.data();
                const clientEmail = clientData.email;

                // B. Fetch N8N Data
                let n8nPlanData = null;
                
                if (clientEmail) {
                    const planQuery = await db.collection("clientPlans")
                                              .where("clientKey", "==", clientEmail)
                                              .limit(1)
                                              .get();

                    if (!planQuery.empty) {
                        const n8nDoc = planQuery.docs[0].data();
                        
                        // 1. Parse Food DB
                        if (n8nDoc.recommendedFoodsJson) {
                            try {
                                const parsedFoods = typeof n8nDoc.recommendedFoodsJson === 'string' 
                                    ? JSON.parse(n8nDoc.recommendedFoodsJson) 
                                    : n8nDoc.recommendedFoodsJson;
                                populateFoodDB(parsedFoods);
                            } catch (e) { console.error("Error parsing foods:", e); }
                        }

                      // 2. Parse Initial Plan (updated to handle AI structure)
                        if (n8nDoc.initialPlanJson) {
                            try {
                                // Step A: Parse the outer string from Firebase
                                let rawData = typeof n8nDoc.initialPlanJson === 'string'
                                    ? JSON.parse(n8nDoc.initialPlanJson)
                                    : n8nDoc.initialPlanJson;

                                // Step B: Check if it's buried in the AI "output" structure
                                if (rawData.output && Array.isArray(rawData.output)) {
                                    console.log("Found AI Wrapper, digging for data...");
                                    
                                    // Extract the text string from the AI response
                                    let aiText = rawData.output[0]?.content?.[0]?.text;
                                    
                                    if (aiText) {
                                        // Step C: Remove Markdown formatting (```json ... ```)
                                        const cleanJson = aiText.replace(/```json/g, '').replace(/```/g, '').trim();
                                        
                                        // Step D: Parse the clean JSON
                                        const parsedAI = JSON.parse(cleanJson);
                                        
                                        // Step E: The AI wrapped the plan in a "plan" key (based on your log)
                                        if (parsedAI.plan) {
                                            n8nPlanData = parsedAI.plan;
                                        } else {
                                            n8nPlanData = parsedAI;
                                        }
                                    }
                                } else {
                                    // It wasn't nested, use as is
                                    n8nPlanData = rawData;
                                }
                                
                                console.log("Final Extracted Plan:", n8nPlanData);

                            } catch (e) { 
                                console.error("Error parsing initial plan path:", e); 
                            }
                        }
                    }
                }

                // C. DETERMINE WHICH PLAN TO USE (WITH VALIDATION)
                
                // PRIORITY 1: Coach's Saved Plan
                // VALIDATION CHECK: Does it have 'days'?
                if (clientData.nutritionPlan && Array.isArray(clientData.nutritionPlan.days)) {
                    console.log("Loading Coach's Saved Plan...");
                    currentPlan = clientData.nutritionPlan;
                } 
                // PRIORITY 2: N8N Generated Plan
                // VALIDATION CHECK: Does it have 'days'?
                else if (n8nPlanData && Array.isArray(n8nPlanData.days)) {
                    console.log("Loading N8N Generated Plan...");
                    currentPlan = n8nPlanData;
                } 
                // PRIORITY 3: Fallback Calculator
                else {
                    console.warn("No valid plan found (missing 'days' array). Generating fallback.");
                    currentPlan = generateFallbackPlan(clientData);
                }

                // Ensure names are up to date
                currentPlan.clientName = `${clientData.firstName || ''} ${clientData.lastName || ''}`;
                currentPlan.clientEmail = clientData.email || '';

                renderPlan(currentPlan);
                attachDelegatedSearchHandler();

            } catch (error) {
                console.error("Error loading data:", error);
                document.getElementById('plan-container').innerHTML = `<p class='text-center text-red-500 mt-10'>Error loading data: ${error.message}</p>`;
            }
        }

        // --- HELPER: Convert USDA JSON to Editor Format ---
        function populateFoodDB(apiFoods) {
            FOOD_DB = {}; 
            if (!Array.isArray(apiFoods)) return;

            apiFoods.forEach(item => {
                let group = item.Category || 'Other'; // Use N8N category if available
                
                // Fallback to macro logic if Category is generic
                if (!item.Category || item.Category === 'meal' || item.Category === 'other') {
                    const p = parseFloat(item.Protein_g) || 0;
                    const c = parseFloat(item.Carbs_g) || 0;
                    const f = parseFloat(item.Fat_g) || 0;
                    if (p > c && p > f) group = 'Protein';
                    else if (c > p && c > f) group = 'Carb';
                    else if (f > p && f > c) group = 'Fat';
                }

                // Safe ID creation
                const safeId = item.foodId || `gen_${Math.random().toString(36).substr(2, 9)}`;
                
                FOOD_DB[safeId] = {
                    name: item.Food,
                    cal: item.Calories,
                    pro: item.Protein_g,
                    carb: item.Carbs_g,
                    fat: item.Fat_g,
                    group: group,
                    brand: item.Brand 
                };
            });
        }

        // --- FALLBACK GENERATOR (Last Resort) ---
        function generateFallbackPlan(clientData) {
            // This only runs if N8N failed completely
            return {
                goalCalories: 2000,
                macroTargets: { protein: 150, carbs: 200, fat: 65, proPct: 30, carbPct: 40, fatPct: 30, totalPctSum: 100 },
                days: [
                    { dayName: 'Day 1', meals: [{ mealName: 'Breakfast', items: [] }, { mealName: 'Lunch', items: [] }, { mealName: 'Dinner', items: [] }] },
                    { dayName: 'Day 2', meals: [{ mealName: 'Breakfast', items: [] }, { mealName: 'Lunch', items: [] }, { mealName: 'Dinner', items: [] }] }
                ]
            };
        }

        // --- 5. SAVING TO FIRESTORE ---
        function updatePlanInFirestore(newPlan) {
            const statusEl = document.getElementById('save-status');
            statusEl.textContent = 'Saving...';
            statusEl.className = "mt-3 text-center text-sm font-bold text-gray-400";
            
            db.collection("clients").doc(clientId).update({
                nutritionPlan: newPlan,
                intakeStatus: "Completed", 
                planLastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                statusEl.textContent = 'Plan Saved & Marked Complete!';
                statusEl.className = "mt-3 text-center text-sm font-bold text-success";
                setTimeout(() => { statusEl.textContent = ''; }, 3000);
            }).catch((error) => {
                console.error("Error saving:", error);
                statusEl.textContent = 'Error saving.';
                statusEl.className = "mt-3 text-center text-sm font-bold text-secondary";
            });
        }

        // --- 6. LOGIC HELPERS ---
        function getMealKey(mealName, itemIndex) { return `${mealName}-${itemIndex}`; }
        
        function filterFoodItems(query) {
            const lowerQuery = query.toLowerCase().trim();
            if (lowerQuery.length < 2) return [];
            const results = [];
            for (const id in FOOD_DB) {
                if (FOOD_DB[id].name.toLowerCase().includes(lowerQuery)) {
                    results.push({ id, name: FOOD_DB[id].name, group: FOOD_DB[id].group });
                }
                if (results.length >= MAX_SEARCH_RESULTS) break;
            }
            return results;
        }

        function calculateDayTotals(plan) {
            const day = plan.days[currentDayIndex];
            let totalCal = 0, totalP = 0, totalC = 0, totalF = 0;
            day.meals.forEach(meal => {
                meal.mealCal = 0; meal.mealP = 0; meal.mealC = 0; meal.mealF = 0;
                meal.items.forEach(item => {
                    const food = FOOD_DB[item.foodItemId];
                    if (food) {
                        const factor = (Number(item.amount) || 0); // Logic adjusted: Amount is usually "serving" or "g"
                        // If unit is "serving", factor is directly amount. If "g", factor is amount/100 (assuming 100g base)
                        // For USDA data, your base is usually 1 serving or 100g. 
                        // To keep it simple for now, we assume linear multiplication:
                        
                        item.calculatedCal = Math.round(food.cal * factor);
                        item.calculatedP = (food.pro * factor);
                        item.calculatedC = (food.carb * factor);
                        item.calculatedF = (food.fat * factor);
                        
                        meal.mealCal += item.calculatedCal; meal.mealP += item.calculatedP; meal.mealC += item.calculatedC; meal.mealF += item.calculatedF;
                    }
                });
                totalCal += meal.mealCal; totalP += meal.mealP; totalC += meal.mealC; totalF += meal.mealF;
            });
            return { calories: totalCal, protein: totalP.toFixed(1), carbs: totalC.toFixed(1), fat: totalF.toFixed(1) };
        }

        function calculateTargetsFromPercentage(currentPlan, targetId, targetValue, newGoalCalories) {
            const newPlan = JSON.parse(JSON.stringify(currentPlan));
            const targets = newPlan.macroTargets;
            newPlan.goalCalories = newGoalCalories;
            if (targetId) targets[targetId] = targetValue;
            
            const pPct = targets.proPct; const cPct = targets.carbPct; const fPct = targets.fatPct;
            const calPro = newPlan.goalCalories * (pPct / 100);
            const calCarb = newPlan.goalCalories * (cPct / 100);
            const calFat = newPlan.goalCalories * (fPct / 100);

            targets.protein = Math.round(calPro / CAL_PER_PRO);
            targets.carbs = Math.round(calCarb / CAL_PER_CARB);
            targets.fat = Math.round(calFat / CAL_PER_FAT);
            targets.totalPctSum = Math.round(targets.proPct + targets.carbPct + targets.fatPct);
            return newPlan;
        }

        // --- 7. UI RENDERING ---
        function renderPlan(plan) {
            const day = plan.days[currentDayIndex];
            const totals = calculateDayTotals(plan);
            const targets = plan.macroTargets;
            
            const renderMacroBar = (value, target, label, color) => {
                const percentage = target > 0 ? Math.min(100, (Number(value) / target) * 100).toFixed(0) : 0;
                const statusColor = Number(value) > target ? 'bg-secondary' : color; 
                return `<div class="mb-4"><div class="flex justify-between text-sm font-medium mb-1"><span class="text-gray-300">${label}</span><span class="text-gray-300">${Number(value).toFixed(0)}g / ${target}g (${percentage}%)</span></div><div class="progress-bar-container"><div class="progress-bar ${statusColor}" style="width: ${percentage}%;"></div></div></div>`;
            };

            const renderAddFoodBar = (mealName) => {
                return `<div id="add-bar-${mealName}" class="add-food-bar p-3 bg-gray-700 rounded-lg ${mealAddBarVisible[mealName] ? '' : 'hidden'}"><h4 class="text-sm font-semibold mb-2">Add Item:</h4><div class="flex space-x-3 items-center"><div class="relative w-full"><input type="text" id="food-search-add-${mealName}" data-meal="${mealName}" class="food-search-input food-search-add w-full p-2 border border-gray-600 rounded-lg text-gray-200 bg-gray-800" placeholder="Type food name..." value="${activeSearches[`add-${mealName}`] || ''}" /><div id="food-results-add-${mealName}" class="search-results absolute z-10 w-full mt-1 bg-gray-600 rounded-lg shadow-xl max-h-48 overflow-y-auto hidden"></div></div><input id="amount-input-${mealName}" type="number" value="1" step="0.5" class="w-20 p-2 border border-gray-600 rounded-lg text-center text-gray-100 bg-gray-800" /><span class="text-gray-400">serv</span><button data-meal="${mealName}" class="add-item-btn p-2 bg-success text-white rounded-lg"><i class="fa-solid fa-check"></i></button></div></div>`;
            };

            const renderMealCard = (meal, mealIndex) => {
                const isEditing = mealEditingState[meal.mealName] || false;
                return `<div class="bg-gray-800 p-4 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                        <h3 class="text-xl font-bold text-secondary">${meal.mealName}</h3>
                        <div class="flex space-x-3">
                            <button data-meal="${meal.mealName}" class="edit-meal-btn text-primary ${isEditing ? 'hidden' : ''}"><i class="fa-solid fa-pen-to-square fa-lg"></i></button>
                            <button data-meal="${meal.mealName}" class="add-item-toggle-btn text-success ${isEditing ? '' : 'hidden'}"><i class="fa-solid fa-plus-circle fa-lg"></i></button>
                            <button data-meal="${meal.mealName}" class="save-meal-edit-btn text-primary ${isEditing ? '' : 'hidden'}"><i class="fa-solid fa-floppy-disk fa-lg"></i></button>
                        </div>
                    </div>
                    ${renderAddFoodBar(meal.mealName)}
                    <div class="space-y-4 pt-3">
                        ${meal.items.map((item, idx) => {
                            const foodName = FOOD_DB[item.foodItemId]?.name || 'Unknown Item';
                            return `<div class="flex flex-col sm:flex-row items-center p-3 border border-gray-700 rounded-lg bg-gray-900">
                                <div class="flex-grow w-full mr-4 text-gray-200">${foodName}</div>
                                <div class="flex items-center space-x-3 w-full sm:w-auto justify-end">
                                    <div class="flex items-center">
                                        <input type="number" class="item-amount-input w-20 p-2 border border-gray-600 rounded-lg text-center text-gray-100 bg-gray-700" value="${item.amount}" data-meal="${meal.mealName}" data-index="${idx}" ${!isEditing ? 'disabled' : ''} />
                                        <span class="text-sm text-gray-400 ml-2">${item.unit || 'serv'}</span>
                                    </div>
                                    <div class="text-sm font-mono text-gray-400 min-w-[100px] text-right"><span class="text-primary font-bold">${item.calculatedCal || 0} Cal</span></div>
                                    <button class="delete-item-btn text-secondary ${isEditing ? '' : 'hidden'}" data-meal="${meal.mealName}" data-index="${idx}"><i class="fa-solid fa-trash-can"></i></button>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                    <div class="mt-4 pt-3 border-t border-gray-700 text-sm font-semibold flex justify-between">
                        <span class="text-gray-400">MEAL TOTALS:</span>
                        <span class="text-gray-200">${meal.mealCal || 0} Cal | P: ${(meal.mealP || 0).toFixed(1)}g</span>
                    </div>
                </div>`;
            };

            const html = `
                <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-2xl h-fit sticky top-4 border border-gray-700">
                        <h1 class="text-2xl font-bold text-primary mb-6">Goals</h1>
                        <div class="mb-6 p-4 bg-gray-900 rounded-lg border border-gray-700">
                            <div class="flex justify-between items-center mb-4">
                                <p class="text-gray-400 text-sm">TARGET CALORIES</p>
                                <input type="number" id="goal-calorie-input" value="${plan.goalCalories}" class="input-as-text text-4xl font-extrabold text-white text-right w-24" style="border-bottom: ${isGoalEditing ? '1px solid #1D4ED8' : 'none'};" ${!isGoalEditing ? 'disabled' : ''} />
                            </div>
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div><p class="text-2xl font-bold text-protein">${targets.protein}g</p><p class="text-xs text-gray-500">Protein</p></div>
                                <div><p class="text-2xl font-bold text-info">${targets.carbs}g</p><p class="text-xs text-gray-500">Carbs</p></div>
                                <div><p class="text-2xl font-bold text-warning">${targets.fat}g</p><p class="text-xs text-gray-500">Fat</p></div>
                            </div>
                            <button id="toggle-goal-edit-btn" class="w-full py-2 mt-4 font-bold rounded-lg ${isGoalEditing ? 'bg-success' : 'bg-primary'} text-white">
                                ${isGoalEditing ? 'Save Goals' : 'Edit Goals'}
                            </button>
                        </div>
                        <div class="mt-5 pt-5 border-t border-gray-700">
                            <h3 class="text-lg font-bold text-gray-200 mb-4">Current Status</h3>
                            ${renderMacroBar(totals.protein, targets.protein, 'Protein', 'bg-protein')}
                            ${renderMacroBar(totals.carbs, targets.carbs, 'Carbs', 'bg-info')}
                            ${renderMacroBar(totals.fat, targets.fat, 'Fat', 'bg-warning')}
                        </div>
                        <div class="mt-4 border-t border-gray-700 pt-4 flex flex-col space-y-2">
                            ${plan.days.map((d, i) => `<button data-day-index="${i}" class="day-nav-btn w-full text-left p-2 rounded-lg ${i === currentDayIndex ? 'bg-primary text-white' : 'bg-gray-700 text-gray-300'}">${d.dayName}</button>`).join('')}
                        </div>
                        <div class="mt-5 pt-5 border-t border-gray-700 space-y-3">
                            <button id="show-shopping-list-btn" class="w-full py-3 bg-gray-700 text-white rounded-lg font-bold">Show Shopping List</button>
                            <button id="save-plan-btn" class="w-full py-3 bg-secondary text-white rounded-lg font-bold">Save Changes</button>
                            <button id="email-plan-btn" class="w-full py-3 bg-primary text-white rounded-lg font-bold">Email Plan</button>
                            <div id="save-status"></div>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="mb-4">
                            <h2 class="text-3xl font-bold text-gray-100">${day.dayName} - ${plan.clientName}</h2>
                        </div>
                        <div class="custom-scrollbar h-[80vh] overflow-y-auto pr-2">
                            ${day.meals.map(renderMealCard).join('')}
                        </div>
                    </div>
                </div>`;
            
            document.getElementById('plan-container').innerHTML = html;
        }

        // --- 8. EVENT DELEGATION ---
        function attachDelegatedSearchHandler() {
            const container = document.getElementById('plan-container');
            
            container.onclick = (e) => {
                const target = e.target.closest('button, .search-result-item');
                if(!target) return;

                if (target.classList.contains('day-nav-btn')) {
                    currentDayIndex = parseInt(target.dataset.dayIndex, 10);
                    renderPlan(currentPlan);
                }
                if (target.classList.contains('edit-meal-btn')) {
                    mealEditingState[target.dataset.meal] = true;
                    renderPlan(currentPlan);
                }
                if (target.classList.contains('add-item-toggle-btn')) {
                    mealAddBarVisible[target.dataset.meal] = !mealAddBarVisible[target.dataset.meal];
                    renderPlan(currentPlan);
                }
                if (target.classList.contains('save-meal-edit-btn')) {
                    mealEditingState[target.dataset.meal] = false;
                    renderPlan(currentPlan);
                }
                if (target.id === 'save-plan-btn') {
                    updatePlanInFirestore(currentPlan);
                }
                if (target.classList.contains('delete-item-btn')) {
                    const meal = currentPlan.days[currentDayIndex].meals.find(m => m.mealName === target.dataset.meal);
                    meal.items.splice(target.dataset.index, 1);
                    renderPlan(currentPlan);
                }
                if (target.classList.contains('add-item-btn')) {
                    const mealName = target.dataset.meal;
                    const input = document.getElementById(`food-search-add-${mealName}`);
                    const amountInput = document.getElementById(`amount-input-${mealName}`);
                    const foodId = input.dataset.selectedId;
                    if(foodId) {
                        const meal = currentPlan.days[currentDayIndex].meals.find(m => m.mealName === mealName);
                        // Default to 1 serving if adding via search
                        meal.items.push({ foodItemId: foodId, amount: parseFloat(amountInput.value) || 1, unit: 'serv' });
                        mealAddBarVisible[mealName] = false;
                        renderPlan(currentPlan);
                    }
                }
                if (target.classList.contains('search-result-item')) {
                    const inputId = `food-search-add-${target.dataset.meal}`;
                    const input = document.getElementById(inputId);
                    input.value = FOOD_DB[target.dataset.foodId].name;
                    input.dataset.selectedId = target.dataset.foodId;
                    document.getElementById(`food-results-add-${target.dataset.meal}`).classList.add('hidden');
                }
                if(target.id === 'toggle-goal-edit-btn') {
                    if(isGoalEditing) {
                        const newCal = document.getElementById('goal-calorie-input').value;
                        currentPlan = calculateTargetsFromPercentage(currentPlan, null, null, newCal);
                        isGoalEditing = false;
                    } else {
                        isGoalEditing = true;
                    }
                    renderPlan(currentPlan);
                }
                if(target.id === 'show-shopping-list-btn') {
                    const list = generateShoppingList(currentPlan);
                    const modal = document.getElementById('shopping-list-content');
                    modal.innerHTML = Object.keys(list).map(cat => `<h3 class='text-xl text-primary font-bold mt-4'>${cat}</h3><ul>${list[cat].map(i => `<li>${i.amount} ${i.unit} ${i.name}</li>`).join('')}</ul>`).join('');
                    document.getElementById('shopping-list-modal').classList.remove('hidden');
                }
                if(target.id === 'email-plan-btn') {
                    document.getElementById('recipient-email').textContent = currentPlan.clientEmail;
                    document.getElementById('payload-display').textContent = JSON.stringify(currentPlan, null, 2);
                    const subject = encodeURIComponent(`Nutrition Plan for ${currentPlan.clientName}`);
                    const body = encodeURIComponent("Please find your plan attached.");
                    document.getElementById('mail-to-link').href = `mailto:${currentPlan.clientEmail}?subject=${subject}&body=${body}`;
                    document.getElementById('email-confirmation-modal').classList.remove('hidden');
                }
            };

            container.oninput = (e) => {
                if (e.target.classList.contains('food-search-input')) {
                    const query = e.target.value;
                    const results = filterFoodItems(query);
                    const resContainer = document.getElementById(`food-results-add-${e.target.dataset.meal}`);
                    if(results.length > 0) {
                        resContainer.innerHTML = results.map(f => `<div class="p-2 hover:bg-gray-600 cursor-pointer search-result-item" data-food-id="${f.id}" data-meal="${e.target.dataset.meal}">${f.name}</div>`).join('');
                        resContainer.classList.remove('hidden');
                    } else {
                        resContainer.classList.add('hidden');
                    }
                }
                if (e.target.classList.contains('item-amount-input')) {
                    const meal = currentPlan.days[currentDayIndex].meals.find(m => m.mealName === e.target.dataset.meal);
                    meal.items[e.target.dataset.index].amount = e.target.value;
                }
            };
        }

        // --- 9. SHOPPING LIST LOGIC ---
        function generateShoppingList(plan) {
            const list = {};
            plan.days.forEach(day => {
                day.meals.forEach(meal => {
                    meal.items.forEach(item => {
                        const food = FOOD_DB[item.foodItemId];
                        if (food) {
                            const cat = food.group || 'Other';
                            if (!list[cat]) list[cat] = [];
                            const existing = list[cat].find(i => i.name === food.name);
                            if(existing) existing.amount += parseFloat(item.amount);
                            else list[cat].push({ name: food.name, amount: parseFloat(item.amount), unit: 'serv' });
                        }
                    });
                });
            });
            return list;
        }

    </script>

    <div id="plan-header" class="max-w-6xl mx-auto mb-6"></div>
    <div id="plan-container">
        <div class="max-w-4xl mx-auto bg-gray-800 rounded-xl shadow-2xl p-10 text-center border border-gray-700">
            <svg class="animate-spin h-8 w-8 text-primary mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-400">Loading plan...</p>
        </div>
    </div>
</body>
</html>